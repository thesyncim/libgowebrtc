name: Test

on:
  push:
    branches: [main, develop, openh264-runtime]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.25.x'
  GO_VERSION_FULL: '1.25.0'  # Full version for direct downloads (Rosetta job)
  SHIM_VERSION: shim-v0.4.2

jobs:
  # Native platform tests
  test:
    name: ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin_arm64
            extension: dylib
          - os: ubuntu-latest
            platform: linux_amd64
            extension: so
          - os: ubuntu-24.04-arm
            platform: linux_arm64
            extension: so
          - os: windows-latest
            platform: windows_amd64
            extension: dll

    steps:
      - uses: actions/checkout@v4

      - name: Detect shim changes
        id: shim_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shim:
              - 'shim/**'
              - 'scripts/build.sh'
              - 'BUILD.bazel'
              - 'MODULE.bazel'
              - 'MODULE.bazel.lock'
              - 'bazel/**'
              - '.bazelrc'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Bazelisk
        if: steps.shim_changes.outputs.shim == 'true'
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ matrix.platform }}
          repository-cache: true

      - name: Install Linux dependencies
        if: runner.os == 'Linux' && steps.shim_changes.outputs.shim == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev libxcomposite-dev libxdamage-dev libxext-dev \
            libxfixes-dev libxrandr-dev libxrender-dev libxtst-dev \
            libglib2.0-dev libgbm-dev libdrm-dev

      - name: Build shim (Unix)
        if: runner.os != 'Windows' && steps.shim_changes.outputs.shim == 'true'
        run: ./scripts/build.sh
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Build shim (Windows)
        if: runner.os == 'Windows' && steps.shim_changes.outputs.shim == 'true'
        shell: bash
        run: ./scripts/build.sh
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Download pre-built shim (Unix)
        if: runner.os != 'Windows' && steps.shim_changes.outputs.shim != 'true'
        run: |
          mkdir -p lib/${{ matrix.platform }}
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_${{ matrix.platform }}.tar.gz" \
            | tar -xz -C lib/${{ matrix.platform }}
          ls -la lib/${{ matrix.platform }}/

      - name: Download pre-built shim (Windows)
        if: runner.os == 'Windows' && steps.shim_changes.outputs.shim != 'true'
        shell: bash
        run: |
          mkdir -p lib/${{ matrix.platform }}
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_${{ matrix.platform }}.tar.gz" \
            | tar -xz -C lib/${{ matrix.platform }}
          ls -la lib/${{ matrix.platform }}/

      - name: Run tests (purego - default)
        shell: bash
        run: |
          echo "=== Testing with purego (default) ==="
          go test -v ./pkg/frame/... ./pkg/codec/...
          go test -v ./internal/ffi/...
          go test -v ./pkg/encoder/... ./pkg/decoder/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Run tests (CGO variant)
        if: runner.os != 'Windows'  # CGO tests need extra setup on Windows
        run: |
          echo "=== Testing with CGO (ffigo_cgo tag) ==="
          go test -tags ffigo_cgo -v ./pkg/frame/... ./pkg/codec/...
          go test -tags ffigo_cgo -v ./internal/ffi/...
          go test -tags ffigo_cgo -v ./pkg/encoder/... ./pkg/decoder/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Run benchmarks (comparison)
        if: runner.os != 'Windows'
        run: |
          echo "=== Benchmark: purego ==="
          go test -bench=BenchmarkShimVersion -benchmem -run=^$ ./internal/ffi/ || true
          echo ""
          echo "=== Benchmark: CGO ==="
          go test -tags ffigo_cgo -bench=BenchmarkShimVersion -benchmem -run=^$ ./internal/ffi/ || true
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Build and smoke-test examples
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "=== Building and smoke-testing examples ==="
          for dir in examples/*/; do
            if [ -f "${dir}main.go" ]; then
              name=$(basename "$dir")
              echo "Building ${name}..."
              go build -o "/tmp/${name}" "./${dir}"

              echo "Smoke-testing ${name} (3s timeout)..."
              "/tmp/${name}" &
              PID=$!
              sleep 3
              if kill -0 $PID 2>/dev/null; then
                echo "  ${name}: OK (still running, stopping)"
                kill $PID 2>/dev/null || true
                wait $PID 2>/dev/null || true
              else
                wait $PID
                EXIT_CODE=$?
                if [ $EXIT_CODE -ne 0 ]; then
                  echo "  ${name}: FAILED (exit code $EXIT_CODE)"
                  exit 1
                fi
                echo "  ${name}: OK (exited cleanly)"
              fi
            fi
          done
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

  # darwin_amd64 via Rosetta emulation on ARM64 runner
  test-darwin-amd64-rosetta:
    name: darwin_amd64 (Rosetta)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Detect shim changes
        id: shim_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shim:
              - 'shim/**'
              - 'scripts/build.sh'
              - 'BUILD.bazel'
              - 'MODULE.bazel'
              - 'MODULE.bazel.lock'
              - 'bazel/**'
              - '.bazelrc'

      - name: Setup Go (x86_64 via Rosetta)
        run: |
          curl -fsSL "https://go.dev/dl/go${{ env.GO_VERSION_FULL }}.darwin-amd64.tar.gz" -o go.tar.gz
          sudo rm -rf /usr/local/go-amd64
          sudo mkdir -p /usr/local/go-amd64
          sudo tar -C /usr/local/go-amd64 -xzf go.tar.gz --strip-components=1
          rm go.tar.gz

      - name: Setup Bazelisk
        if: steps.shim_changes.outputs.shim == 'true'
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: darwin_amd64
          repository-cache: true

      - name: Build shim (darwin_amd64)
        if: steps.shim_changes.outputs.shim == 'true'
        run: ./scripts/build.sh --target darwin_amd64
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Download pre-built shim
        if: steps.shim_changes.outputs.shim != 'true'
        run: |
          mkdir -p lib/darwin_amd64
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_darwin_amd64.tar.gz" \
            | tar -xz -C lib/darwin_amd64
          ls -la lib/darwin_amd64/
          file lib/darwin_amd64/libwebrtc_shim.dylib

      - name: Run tests via Rosetta
        run: |
          echo "=== Testing darwin_amd64 via Rosetta ==="
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./pkg/frame/... ./pkg/codec/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./internal/ffi/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./pkg/encoder/... ./pkg/decoder/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/darwin_amd64/libwebrtc_shim.dylib
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Run tests (CGO variant via Rosetta)
        run: |
          echo "=== Testing with CGO via Rosetta ==="
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./pkg/frame/... ./pkg/codec/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./internal/ffi/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./pkg/encoder/... ./pkg/decoder/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/darwin_amd64/libwebrtc_shim.dylib
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Build and smoke-test examples (via Rosetta)
        run: |
          echo "=== Building and smoke-testing examples ==="
          for dir in examples/*/; do
            if [ -f "${dir}main.go" ]; then
              name=$(basename "$dir")
              echo "Building ${name}..."
              arch -x86_64 /usr/local/go-amd64/bin/go build -o "/tmp/${name}" "./${dir}"

              echo "Smoke-testing ${name} (3s timeout)..."
              arch -x86_64 "/tmp/${name}" &
              PID=$!
              sleep 3
              if kill -0 $PID 2>/dev/null; then
                echo "  ${name}: OK (still running, stopping)"
                kill $PID 2>/dev/null || true
                wait $PID 2>/dev/null || true
              else
                wait $PID
                EXIT_CODE=$?
                if [ $EXIT_CODE -ne 0 ]; then
                  echo "  ${name}: FAILED (exit code $EXIT_CODE)"
                  exit 1
                fi
                echo "  ${name}: OK (exited cleanly)"
              fi
            fi
          done
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/darwin_amd64/libwebrtc_shim.dylib
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"
