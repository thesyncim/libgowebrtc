name: Test

on:
  push:
    branches: [main, develop, openh264-runtime]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: '1.25.x'
  GO_VERSION_FULL: '1.25.0'  # Full version for direct downloads (Rosetta job)
  SHIM_VERSION: shim-v0.4.1

jobs:
  # Native platform tests
  test:
    name: ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin_arm64
            extension: dylib
          - os: ubuntu-latest
            platform: linux_amd64
            extension: so
          - os: ubuntu-24.04-arm
            platform: linux_arm64
            extension: so
          - os: windows-latest
            platform: windows_amd64
            extension: dll

    steps:
      - uses: actions/checkout@v4

      - name: Detect shim changes
        id: shim_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shim:
              - 'shim/**'
              - 'scripts/build.sh'
              - 'BUILD.bazel'
              - 'MODULE.bazel'
              - 'MODULE.bazel.lock'
              - 'bazel/**'
              - '.bazelrc'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Bazelisk
        if: steps.shim_changes.outputs.shim == 'true'
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ matrix.platform }}
          repository-cache: true

      - name: Install Linux dependencies
        if: runner.os == 'Linux' && steps.shim_changes.outputs.shim == 'true'
        run: |
          sudo apt-get update
          # Install clang and libc++ for building (libwebrtc is built with clang/libc++)
          # Try versioned packages first (Ubuntu 22.04/24.04)
          LLVM_VERSION=$(apt-cache search '^clang-[0-9]+$' | sort -V | tail -1 | grep -oP 'clang-\K[0-9]+' || echo "")
          if [ -n "$LLVM_VERSION" ]; then
            echo "Installing clang-${LLVM_VERSION} and libc++-${LLVM_VERSION}..."
            sudo apt-get install -y \
              clang-${LLVM_VERSION} \
              libc++-${LLVM_VERSION}-dev \
              libc++abi-${LLVM_VERSION}-dev \
              lld-${LLVM_VERSION} || true
            # Create symlinks if needed
            sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${LLVM_VERSION} 100 || true
            sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-${LLVM_VERSION} 100 || true
            sudo update-alternatives --install /usr/bin/lld lld /usr/bin/lld-${LLVM_VERSION} 100 || true
            sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-${LLVM_VERSION} 100 || true
          else
            echo "Installing unversioned clang and libc++..."
            sudo apt-get install -y clang libc++-dev libc++abi-dev lld || true
          fi
          # Install X11 and other dependencies
          sudo apt-get install -y \
            libx11-dev libxcomposite-dev libxdamage-dev libxext-dev \
            libxfixes-dev libxrandr-dev libxrender-dev libxtst-dev \
            libglib2.0-dev libgbm-dev libdrm-dev
          # Verify clang and libc++ are available
          echo "=== Clang version ==="
          clang++ --version || echo "clang++ not found"
          echo "=== libc++ shared libraries ==="
          find /usr -name 'libc++.so*' -o -name 'libc++abi.so*' 2>/dev/null | head -10 || echo "libc++ not found"

      - name: Build shim (Unix)
        if: runner.os != 'Windows' && steps.shim_changes.outputs.shim == 'true'
        run: ./scripts/build.sh
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Build shim (Windows)
        if: runner.os == 'Windows' && steps.shim_changes.outputs.shim == 'true'
        shell: bash
        run: ./scripts/build.sh
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Install libc++ runtime (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # Install LLVM libc++ runtime - the shim is built with clang's libc++
          # which uses a different ABI than libstdc++. We need the runtime library.
          # Try versioned packages first (Ubuntu 22.04/24.04), then fall back to unversioned
          if ! sudo apt-get install -y libc++1 libc++abi1 2>/dev/null; then
            echo "libc++1 not available, trying versioned packages..."
            # Find available libc++ version
            LIBC_VERSION=$(apt-cache search '^libc\+\+-[0-9]+-dev$' | head -1 | grep -oP 'libc\+\+-\K[0-9]+' || echo "")
            if [ -n "$LIBC_VERSION" ]; then
              echo "Installing libc++ version $LIBC_VERSION..."
              sudo apt-get install -y "libc++-${LIBC_VERSION}-dev" "libc++abi-${LIBC_VERSION}-dev" || true
            else
              echo "No versioned libc++ found, trying generic..."
              sudo apt-get install -y libc++-dev libc++abi-dev || true
            fi
          fi
          # Update library cache
          sudo ldconfig
          # Verify libc++ is available
          echo "=== Checking libc++ availability ==="
          ldconfig -p | grep -i libc++ || echo "Warning: libc++ not found in ldconfig"
          # Show what version was installed
          dpkg -l | grep -i libc++ || true
          # Check if the symbol is available
          echo "=== Checking for ostringstream symbol ==="
          for lib in /usr/lib/*/libc++.so* /usr/lib/libc++.so*; do
            if [ -f "$lib" ]; then
              echo "Checking $lib..."
              nm -D "$lib" 2>/dev/null | grep -i ostringstream | head -5 || true
            fi
          done

      - name: Download pre-built shim (Unix)
        if: runner.os != 'Windows' && steps.shim_changes.outputs.shim != 'true'
        run: |
          mkdir -p lib/${{ matrix.platform }}
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_${{ matrix.platform }}.tar.gz" \
            | tar -xz -C lib/${{ matrix.platform }}
          ls -la lib/${{ matrix.platform }}/
          # Debug: check library dependencies on Linux
          if [ "$RUNNER_OS" = "Linux" ]; then
            echo "=== Checking shim dependencies ==="
            ldd lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }} || true
            echo "=== Checking for undefined symbols ==="
            nm -u lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }} | head -50 || true
          fi

      - name: Download pre-built shim (Windows)
        if: runner.os == 'Windows' && steps.shim_changes.outputs.shim != 'true'
        shell: bash
        run: |
          mkdir -p lib/${{ matrix.platform }}
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_${{ matrix.platform }}.tar.gz" \
            | tar -xz -C lib/${{ matrix.platform }}
          ls -la lib/${{ matrix.platform }}/

      - name: Run tests (purego - default)
        shell: bash
        run: |
          echo "=== Testing with purego (default) ==="
          go test -v ./pkg/frame/... ./pkg/codec/...
          go test -v ./internal/ffi/...
          go test -v ./pkg/encoder/... ./pkg/decoder/...
          go test -v ./test/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"
          # Add libc++ paths for Linux - the shim is built with LLVM's libc++
          LD_LIBRARY_PATH: ${{ runner.os == 'Linux' && '/usr/lib/llvm-18/lib:/usr/lib/llvm-17/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu' || '' }}

      - name: Run tests (CGO variant)
        if: runner.os != 'Windows'  # CGO tests need extra setup on Windows
        run: |
          echo "=== Testing with CGO (ffigo_cgo tag) ==="
          go test -tags ffigo_cgo -v ./pkg/frame/... ./pkg/codec/...
          go test -tags ffigo_cgo -v ./internal/ffi/...
          go test -tags ffigo_cgo -v ./pkg/encoder/... ./pkg/decoder/...
          go test -tags ffigo_cgo -v ./test/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"
          # Add libc++ paths for Linux - the shim is built with LLVM's libc++
          LD_LIBRARY_PATH: /usr/lib/llvm-18/lib:/usr/lib/llvm-17/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu

      - name: Run benchmarks (comparison)
        if: runner.os != 'Windows'
        run: |
          echo "=== Benchmark: purego ==="
          go test -bench=BenchmarkShimVersion -benchmem -run=^$ ./internal/ffi/ || true
          echo ""
          echo "=== Benchmark: CGO ==="
          go test -tags ffigo_cgo -bench=BenchmarkShimVersion -benchmem -run=^$ ./internal/ffi/ || true
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/${{ matrix.platform }}/libwebrtc_shim.${{ matrix.extension }}
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"
          LD_LIBRARY_PATH: /usr/lib/llvm-18/lib:/usr/lib/llvm-17/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu

  # darwin_amd64 via Rosetta emulation on ARM64 runner
  test-darwin-amd64-rosetta:
    name: darwin_amd64 (Rosetta)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Detect shim changes
        id: shim_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shim:
              - 'shim/**'
              - 'scripts/build.sh'
              - 'BUILD.bazel'
              - 'MODULE.bazel'
              - 'MODULE.bazel.lock'
              - 'bazel/**'
              - '.bazelrc'

      - name: Setup Go (x86_64 via Rosetta)
        run: |
          curl -fsSL "https://go.dev/dl/go${{ env.GO_VERSION_FULL }}.darwin-amd64.tar.gz" -o go.tar.gz
          sudo rm -rf /usr/local/go-amd64
          sudo mkdir -p /usr/local/go-amd64
          sudo tar -C /usr/local/go-amd64 -xzf go.tar.gz --strip-components=1
          rm go.tar.gz

      - name: Setup Bazelisk
        if: steps.shim_changes.outputs.shim == 'true'
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          bazelisk-cache: true
          disk-cache: darwin_amd64
          repository-cache: true

      - name: Build shim (darwin_amd64)
        if: steps.shim_changes.outputs.shim == 'true'
        run: ./scripts/build.sh --target darwin_amd64
        env:
          INSTALL_DIR: ${{ runner.temp }}/libwebrtc

      - name: Download pre-built shim
        if: steps.shim_changes.outputs.shim != 'true'
        run: |
          mkdir -p lib/darwin_amd64
          curl -fsSL --retry 10 --retry-delay 20 --retry-all-errors \
            "https://github.com/${{ github.repository }}/releases/download/${{ env.SHIM_VERSION }}/libwebrtc_shim_darwin_amd64.tar.gz" \
            | tar -xz -C lib/darwin_amd64
          ls -la lib/darwin_amd64/
          file lib/darwin_amd64/libwebrtc_shim.dylib

      - name: Run tests via Rosetta
        run: |
          echo "=== Testing darwin_amd64 via Rosetta ==="
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./pkg/frame/... ./pkg/codec/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./internal/ffi/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./pkg/encoder/... ./pkg/decoder/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -v ./test/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/darwin_amd64/libwebrtc_shim.dylib
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"

      - name: Run tests (CGO variant via Rosetta)
        run: |
          echo "=== Testing with CGO via Rosetta ==="
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./pkg/frame/... ./pkg/codec/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./internal/ffi/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./pkg/encoder/... ./pkg/decoder/...
          arch -x86_64 /usr/local/go-amd64/bin/go test -tags ffigo_cgo -v ./test/...
        env:
          LIBWEBRTC_SHIM_PATH: ${{ github.workspace }}/lib/darwin_amd64/libwebrtc_shim.dylib
          LIBWEBRTC_PREFER_SOFTWARE_CODECS: "1"
